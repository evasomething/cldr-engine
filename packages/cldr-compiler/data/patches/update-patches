#!/usr/bin/env python

import argparse, gzip, io, os, json, shutil, sys, tarfile
import requests
# from subprocess import Popen

CWD = os.path.abspath(os.path.dirname(__file__))
sys.path.insert(0, os.path.join(CWD, 'patchlib'))

import languagematch
import pluralrange
import rbnf
from util import makedirs

BASEURL = 'https://github.com/unicode-org/cldr/archive'
TAG = 'release-37-alpha3'
ROOTPATH = 'common'

TEMPDIR = os.path.join(CWD, '..', '..', '.cldrpatches')

BUILDERS = [
    languagematch,
    pluralrange,
    rbnf
]

def get_root():
    return os.path.join(TEMPDIR, TAG)

def download():
    realpath = get_root()
    if not os.path.exists(realpath):
        makedirs(realpath)
        url = os.path.join(BASEURL, '%s.tar.gz' % TAG)
        r = requests.get(url)
        f = gzip.GzipFile(fileobj=io.BytesIO(r.content))
        t = tarfile.TarFile(fileobj=f)
        t.extractall(realpath)
    return os.path.join(realpath, 'cldr-%s' % TAG)

def main():
    makedirs(TEMPDIR)
    realpath = download()
    for builder in BUILDERS:
        builder.build(realpath, CWD)

if __name__ == '__main__':
    main()
