#!/usr/bin/env python

import os, json, shutil, sys
import requests

CWD = os.path.abspath(os.path.dirname(__file__))
sys.path.insert(0, os.path.join(CWD, 'patchlib'))

import languagematch
import pluralrange

TAG = 'release-36'
#BASEURL = 'https://unicode.org/repos/cldr/tags'
BASEURL = 'https://raw.githubusercontent.com/unicode-org/cldr'
TEMPDIR = os.path.join(CWD, '..', '..', '.cldrpatches')

FILES = [
    # The latest languageInfo.xml still doesn't seem to capture
    # the distances expressed in the ticket below.
    # re: en-IN en-GB and en-US distances
    # https://www.unicode.org/cldr/trac/ticket/10148
    #
    # I've decided to keep my own changes for now since I think
    # they better capture the distances expressed in this comment:
    # https://www.unicode.org/cldr/trac/ticket/10148#comment:3
    ('common/supplemental/languageInfo.xml',
    languagematch.build,
    'languageMatching-fix.json'),

    ('common/supplemental/pluralRanges.xml',
    pluralrange.build,
    'pluralRanges-fix.json')
]

def makedirs(path):
    if not os.path.exists(path):
        os.makedirs(path)

def download(path):
    realpath = os.path.join(TEMPDIR, TAG, path)
    if not os.path.exists(realpath):
        url = os.path.join(BASEURL, TAG, path)
        print(url)
        res = requests.get(url)
        makedirs(os.path.dirname(realpath))
        open(realpath, 'wb').write(res.text.encode('utf-8'))
    return realpath

def process(path, builder, dest):
    print(path)
    realpath = download(path)
    rec = builder(realpath)
    out = open(dest, 'wb')
    res = json.dumps(rec, indent=2, sort_keys=1)
    out.write(res.encode('utf-8'))
    out.close()

def main():
    makedirs(TEMPDIR)
    for path, builder, dest in FILES:
        process(path, builder, dest)

if __name__ == '__main__':
    main()

